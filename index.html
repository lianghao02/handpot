<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è™›æ“¬æ‰‹ç¢Ÿé¼“ç·´ç¿’ (Virtual Handpan)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* éš±è—æ²è»¸ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
            font-family: "Noto Sans TC", sans-serif;
            background-color: #111; 
            overflow: hidden;
        }

        .header-bg {
             background-color: rgba(20, 20, 20, 0.8);
             backdrop-filter: blur(8px);
             -webkit-backdrop-filter: blur(8px);
        }

        /* --- æ‰‹ç¢Ÿæœ¬é«”ï¼šå¡åº¦èˆ‡é‡‘å±¬è³ªæ„Ÿ --- */
        .handpan-body {
            /* æ¨¡æ“¬åœ“é ‚å¡åº¦ï¼šä¸­å¿ƒäº®(é«˜)ï¼Œé‚Šç·£æš—(ä½) */
            background: radial-gradient(circle at 40% 40%, #6e6e6e 0%, #3a3a3a 40%, #1f1f1f 85%, #0d0d0d 100%);
            
            box-shadow: 
                0 25px 60px rgba(0, 0, 0, 0.9),       
                inset 0 2px 3px rgba(255, 255, 255, 0.2), 
                inset 0 -10px 20px rgba(0, 0, 0, 0.8);    
                
            border-radius: 50%;
            position: relative;
            transition: transform 0.1s ease;
            z-index: 20; 
            
            width: 85vmin;
            height: 85vmin;
            max-width: 650px;
            max-height: 650px;
        }

        /* --- éŸ³èˆŒç†±å€ï¼šå¾®èª¿å¤§å°èˆ‡ç«‹é«”æ„Ÿ --- */
        .note-field {
            position: absolute;
            border-radius: 50%;
            /* é è¨­é¡è‰² (å‡¹é™·) */
            background: linear-gradient(145deg, #2a2a2a, #3d3d3d);
            box-shadow: 
                inset 1px 1px 3px rgba(0, 0, 0, 0.9), 
                inset -1px -1px 2px rgba(255, 255, 255, 0.05),
                2px 2px 4px rgba(0, 0, 0, 0.4); 
                
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fbbf24; 
            font-weight: bold;
            transition: all 0.05s;
            transform: translate(-50%, -50%);
            text-shadow: 0 1px 2px rgba(0,0,0,0.9); 
            line-height: 1;
            z-index: 25;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- å‘¨åœéŸ³ç¬¦å°ºå¯¸ï¼š22% (æ¶ˆé™¤é‡ç–Š) --- */
        .note-field.tone-field { 
            width: 22%; 
            height: 22%; 
        }

        .note-num { font-size: 1.6rem; color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.2); }
        .note-name { font-size: 0.75rem; color: #888; margin-top: 2px; }

        /* --- ä¸­å¤® Dingï¼šå‡¸èµ·å±±ä¸˜æ„Ÿ --- */
        .ding {
            position: absolute; top: 50%; left: 50%; 
            width: 28%; height: 28%; 
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #888, #222);
            box-shadow: 
                0 10px 20px rgba(0,0,0,0.6), 
                inset 0 1px 5px rgba(255,255,255,0.3);
            z-index: 30;
        }
        .ding .note-num { font-size: 2.4rem; color: #fff; }
        .ding .note-name { color: #fbbf24; }

        /* é»æ“Šå›é¥‹ */
        .note-field.active, .ding.active {
            transform: translate(-50%, -50%) scale(0.96);
            /* é»æ“Šæ™‚é¡è‰²è®Šæ·º */
            background: linear-gradient(145deg, #444, #555);
            /* é»æ“Šæ™‚å¤–ç™¼å…‰ */
            box-shadow: inset 0 0 15px rgba(251, 191, 36, 0.4); 
        }

        /* å’Œå¼¦è¼”åŠ©æ¨¡å¼ä¸‹ï¼Œé«˜äº®çš„éŸ³ç¬¦ */
        .note-field.chord-highlight {
            background: linear-gradient(145deg, #383838, #5a5a5a);
            box-shadow: 0 0 10px #34d399, inset 0 0 8px rgba(52, 211, 163, 0.8);
            transform: translate(-50%, -50%) scale(1.02);
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        }
        .ding.chord-highlight {
            box-shadow: 0 0 10px #34d399, inset 0 0 8px rgba(52, 211, 163, 0.8);
            transform: translate(-50%, -50%) scale(1.02);
        }
        
        .note-field.active .note-num {
            color: #fff;
            text-shadow: 0 0 15px #fbbf24; 
        }
        
        .score-note { font-size: 1.25rem; line-height: 1.8; }
        .playing-highlight {
            color: #ef4444 !important; font-weight: 900 !important; transform: scale(1.2);
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #fbbf24;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-between text-gray-200">

    <!-- Header -->
    <div class="w-full p-3 header-bg flex justify-between items-center z-40 shadow-lg shrink-0 h-[60px]">
        <h1 class="text-lg font-bold text-amber-500 tracking-wider">Handpan <span class="text-xs text-gray-400 hidden sm:inline">D Kurd 10</span></h1>
        <div class="flex gap-2">
            <button id="toggleLabels" class="bg-gray-700 hover:bg-gray-600 text-xs px-3 py-1 rounded transition border border-gray-600">
                éš±è—æ¨™ç±¤
            </button>
        </div>
    </div>

    <!-- Body -->
    <div class="w-full flex-grow flex flex-col md:flex-row relative">
        <!-- Handpan Area -->
        <div id="handpan-container" class="flex-grow flex items-center justify-center relative overflow-hidden p-4 md:w-3/4">
            <!-- èƒŒæ™¯æ°›åœå…‰ -->
            <div class="absolute inset-0 opacity-10 pointer-events-none">
                <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-gray-100/10 rounded-full blur-[100px]"></div>
            </div>
            
            <div id="handpan" class="handpan-body shrink-0">
                <div class="ding note-field" data-note-index="0"></div>
            </div>
        </div>

        <!-- Sidebar / Bottom Bar -->
        <div id="record-sidebar" class="w-full md:w-1/4 md:flex-none p-4 header-bg shadow-inner md:shadow-none 
                                        min-h-[140px] max-h-[25vh] md:max-h-full flex flex-col shrink-0 border-t md:border-t-0 md:border-l border-gray-700 z-40">
            
            <!-- å’Œå¼¦è¼”åŠ©å€å¡Š -->
            <div class="mb-3 border-b border-gray-700 pb-2">
                <span class="text-xs text-emerald-400 font-bold uppercase tracking-widest">Chords (PDF Guide)</span>
                <div id="chordList" class="flex flex-wrap gap-1 mt-1">
                    <!-- Chords will be rendered here -->
                </div>
            </div>

            <!-- è¨˜éŒ„æ§åˆ¶å€å¡Š -->
            <div class="flex flex-wrap justify-between items-center mb-2 border-b border-gray-700 pb-2 gap-2 shrink-0">
                <span class="text-xs text-amber-500 font-bold uppercase tracking-widest">Record</span>
                
                <div class="flex gap-2">
                    <button id="saveCurrent" class="text-xs bg-yellow-600 hover:bg-yellow-500 text-black px-2 py-1 rounded flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>ğŸ’¾</span> å„²å­˜
                    </button>
                    <button id="openRecords" class="text-xs bg-gray-500 hover:bg-gray-400 text-white px-2 py-1 rounded flex items-center gap-1">
                        <span>ğŸ“–</span> è¨˜éŒ„åˆ—è¡¨
                    </button>
                </div>
            </div>
            
            <!-- è¨˜éŒ„æ’­æ”¾æ§åˆ¶å’ŒåŒ¯å‡ºæŒ‰éˆ• -->
            <div class="flex flex-wrap justify-between items-center mb-2 pb-2 gap-2 shrink-0">
                <div class="flex gap-2">
                    <button id="playRecord" class="text-xs bg-green-700 hover:bg-green-600 text-white px-2 py-1 rounded flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>â–¶</span> æ’­æ”¾
                    </button>
                    <button id="exportWav" class="text-xs bg-purple-700 hover:bg-purple-600 text-white px-2 py-1 rounded flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>ğŸ“¥</span> WAV
                    </button>
                    <button id="copyRecord" class="text-xs bg-blue-700 hover:bg-blue-600 text-white px-2 py-1 rounded flex items-center gap-1">
                        <span>ğŸ“‹</span> è¤‡è£½
                    </button>
                    <button id="clearRecord" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 px-2 py-1 rounded">
                        æ¸…é™¤
                    </button>
                </div>
            </div>

            <!-- ç•¶å‰æ¼”å¥æ¨‚è­œé¡¯ç¤ºå€ -->
            <div id="notationDisplay" class="font-mono tracking-wider text-white flex-grow overflow-auto whitespace-nowrap md:whitespace-normal scrollbar-hide relative border-b border-gray-700 pb-2">
                <span class="text-gray-500 text-sm italic absolute top-0 left-0">é»æ“ŠéŸ³éšé–‹å§‹è¨˜éŒ„...</span>
            </div>
            
            <!-- æ­·å²è¨˜éŒ„åˆ—è¡¨ (å¯åˆ‡æ›é¡¯ç¤º) -->
            <div id="savedRecordsSection" class="mt-3 overflow-y-auto scrollbar-hide max-h-48 md:max-h-full transition-all duration-300 ease-in-out" style="max-height: 0; opacity: 0; pointer-events: none;">
                 <h3 class="text-sm font-bold text-gray-400 mb-2 border-b border-gray-800 pb-1">æ­·å²è¨˜éŒ„</h3>
                 <div id="savedRecordsList">
                    <p class="text-xs text-gray-600">ç›®å‰æ²’æœ‰å„²å­˜çš„è¨˜éŒ„ã€‚</p>
                 </div>
            </div>

            <p class="text-gray-600 text-[10px] mt-2 shrink-0 text-center w-full">Low Latency Audio Engine Active</p>
        </div>
    </div>

    <!-- Start Overlay -->
    <div id="startOverlay" class="fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-50 cursor-pointer touch-manipulation">
        <div class="text-amber-500 text-6xl mb-4 animate-pulse">â™«</div>
        <h2 class="text-2xl text-white font-bold mb-2">é»æ“Šå•Ÿç”¨éŸ³æ•ˆ</h2>
        <p class="text-gray-400 text-sm mb-8">å•Ÿå‹•ä½å»¶é²éŸ³è¨Šå¼•æ“ (æ”¯æ´å’Œå¼¦æ¼”å¥)</p>
        <div class="text-xs text-gray-600 px-8 text-center">
            è‹¥ç™¼ç”Ÿå»¶é²ï¼Œè«‹ä½¿ç”¨æœ‰ç·šè€³æ©Ÿï¼Œä¸¦é—œé–‰çœé›»æ¨¡å¼ã€‚
        </div>
    </div>

    <!-- Message Toast -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm transition-opacity opacity-0 pointer-events-none z-50">
        è¨Šæ¯
    </div>
    
    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/70 flex flex-col items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl text-white">æ­£åœ¨è™•ç†éŸ³è¨ŠåŒ¯å‡º...</h2>
        <p class="text-gray-400 text-sm">(è«‹ç¨å€™)</p>
    </div>

<script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const OfflineAudioContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;
    const STORAGE_KEY = 'HANDPAN_SAVED_SCORES';

    let ctx = null;
    let masterGain = null;
    let compressor = null;
    let isAudioInitialized = false;
    let savedScores = [];
    let isRecordsListVisible = false;
    let currentChordHighlight = null; // è¿½è¹¤ç•¶å‰é«˜äº®å’Œå¼¦

    // --- å’Œå¼¦æ•¸æ“š (ä¾†è‡ª PDF Page 3 çš„æ•¸å­—è¨˜è­œæ³•) ---
    const CHORD_DATA = [
        { name: "D-minor", labels: ["D", "1", "4", "6", "8"] },
        { name: "Bb-major", labels: ["D", "2", "4", "6"] },
        { name: "G-minor", labels: ["D", "2", "4", "7"] },
        { name: "A-minor", labels: ["1", "3", "5", "8", "9"] },
        { name: "C-major", labels: ["3", "5", "7", "9"] },
        { name: "F-major", labels: ["1", "3", "6", "8", "9"] },
    ];


    // éŸ³éšè³‡æ–™ (D Kurd 10)
    function getPos(deg, radius = 36) { 
        const rad = deg * (Math.PI / 180);
        return { top: 50 + radius * Math.sin(rad), left: 50 + radius * Math.cos(rad) };
    }
    
    const scaleNotes = [
        { note: "D3", freq: 146.83, label: "D", pos: { top: 50, left: 50 }, type: 'center-note' }, 
        { note: "A3", freq: 220.00, label: "1", pos: getPos(90), rotate: 0 },
        { note: "Bb3", freq: 233.08, label: "2", pos: getPos(130), rotate: 40 },
        { note: "C4", freq: 261.63, label: "3", pos: getPos(50), rotate: -40 },
        { note: "D4", freq: 293.66, label: "4", pos: getPos(170), rotate: 80 },
        { note: "E4", freq: 329.63, label: "5", pos: getPos(10), rotate: -80 },
        { note: "F4", freq: 349.23, label: "6", pos: getPos(210), rotate: 120 },
        { note: "G4", freq: 392.00, label: "7", pos: getPos(330), rotate: -120 },
        { note: "A4", freq: 440.00, label: "8", pos: getPos(250), rotate: 160 },
        { note: "C5", freq: 523.25, label: "9", pos: getPos(290), rotate: -160 } 
    ];

    let isLabelsVisible = true;
    let recordBuffer = []; 
    let recordStartTime = 0;
    let isPlaying = false;
    let playbackTimeouts = [];
    
    let lastRecordTime = 0;
    const CHORD_TOLERANCE_MS = 50; 

    // --- Core Audio & Tone Generation ---
    function initAudio() {
        if (ctx) return;
        ctx = new AudioContext({ latencyHint: 'interactive', sampleRate: 44100 });
        compressor = ctx.createDynamicsCompressor();
        compressor.threshold.setValueAtTime(-20, ctx.currentTime);
        compressor.ratio.setValueAtTime(8, ctx.currentTime);
        masterGain = ctx.createGain();
        masterGain.gain.value = 0.9;
        compressor.connect(masterGain);
        masterGain.connect(ctx.destination);
        const buffer = ctx.createBuffer(1, 1, 22050);
        const source = ctx.createBufferSource();
        source.buffer = buffer;
        source.connect(ctx.destination);
        source.start(0);
        isAudioInitialized = true;
        if (ctx.state === 'suspended') ctx.resume();
    }

    function playTone(freq, when = 0, audioContext = ctx, destination = compressor) {
        if (!audioContext) return;
        const now = when || audioContext.currentTime;
        const attackTime = 0.005; 
        const oscs = [
            { type: 'sine', mult: 1, gain: 0.6, decay: 3.5 },
            { type: 'sine', mult: 2, gain: 0.3, decay: 2.0 },
            { type: 'sine', mult: 3, gain: 0.15, decay: 1.5 },
            { type: 'triangle', mult: 4.5, gain: 0.05, decay: 0.05, isClick: true }
        ];
        oscs.forEach(o => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = o.type;
            osc.frequency.setValueAtTime(freq * o.mult, now);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(o.gain, now + attackTime);
            gain.gain.exponentialRampToValueAtTime(0.001, now + o.decay);
            osc.connect(gain);
            gain.connect(destination);
            osc.start(now);
            osc.stop(now + 4);
        });
    }
    
    // --- Rendering and Events ---

    function renderHandpan() {
        const container = document.getElementById('handpan');
        const ding = container.querySelector('.ding');
        container.innerHTML = ''; 
        const newDing = ding.cloneNode(true);
        container.appendChild(newDing);
        setupNoteElement(newDing, scaleNotes[0], 0);

        scaleNotes.slice(1).forEach((n, i) => {
            const el = document.createElement('div');
            el.className = 'note-field tone-field';
            el.style.left = `${n.pos.left}%`;
            el.style.top = `${n.pos.top}%`;
            if (n.rotate !== undefined) el.style.transform = `translate(-50%, -50%) rotate(${n.rotate}deg)`;
            container.appendChild(el);
            setupNoteElement(el, n, i + 1);
        });
        adjustHandpanSize();
        // é‡æ–°æ¸²æŸ“å¾Œæ¢å¾©å’Œå¼¦é«˜äº®
        if (currentChordHighlight) highlightChord(currentChordHighlight, false);
    }

    function setupNoteElement(el, n, index) {
        const textRotate = n.rotate ? -n.rotate : 0;
        el.innerHTML = isLabelsVisible 
            ? `<div class="pointer-events-none" style="transform: rotate(${textRotate}deg)">
                 <div class="note-num">${n.label}</div>
                 <div class="note-name">${n.note}</div>
               </div>` 
            : '';
        const playHandler = (e) => {
            if (e.type === 'touchstart') e.preventDefault(); 
            triggerNote(index, el);
        };
        el.addEventListener('touchstart', playHandler, { passive: false });
        el.addEventListener('mousedown', playHandler);
        el.dataset.label = n.label; // For chord finding
        el.dataset.index = index;
    }

    function triggerNote(index, element) {
        if (!isAudioInitialized) initAudio();
        if (ctx && ctx.state === 'suspended') ctx.resume();
        if (isPlaying) return; 
        const noteData = scaleNotes[index];
        playTone(noteData.freq);
        if (element) {
            element.classList.add('active');
            setTimeout(() => element.classList.remove('active'), 100);
        } else {
            const allFields = document.querySelectorAll('.note-field');
            const target = allFields[index]; 
            if(target) {
                target.classList.add('active');
                setTimeout(() => target.classList.remove('active'), 100);
            }
        }
        const now = Date.now();
        let relativeTime;
        if (recordBuffer.length === 0) {
            recordStartTime = now;
            relativeTime = 0;
        } else {
            if (now - lastRecordTime < CHORD_TOLERANCE_MS) {
                relativeTime = recordBuffer[recordBuffer.length - 1].time;
            } else {
                relativeTime = now - recordStartTime;
            }
        }
        lastRecordTime = now;
        recordBuffer.push({
            label: noteData.label,
            noteIndex: index,
            time: relativeTime
        });
        updateRecordDisplay();
    }

    function adjustHandpanSize() {
        const container = document.getElementById('handpan-container');
        const handpan = document.getElementById('handpan');
        if (!container || !handpan) return;
        const size = Math.min(container.clientWidth, container.clientHeight) * 0.9; 
        const finalSize = Math.min(size, 650); 
        handpan.style.width = `${finalSize}px`;
        handpan.style.height = `${finalSize}px`;
    }

    function updateRecordDisplay() {
        const display = document.getElementById('notationDisplay');
        const isLandscape = window.innerWidth >= 768;
        display.innerHTML = '';
        let lineBuffer = [];
        recordBuffer.forEach((item, idx) => {
            const span = document.createElement('span');
            span.id = `note-span-${idx}`;
            span.className = 'score-note inline-block font-mono transition-colors duration-100';
            span.className += item.label === 'D' ? ' text-amber-400 font-bold' : ' text-white';
            span.textContent = item.label;
            if (isLandscape) {
                span.className += ' mx-1 my-0.5';
                lineBuffer.push(span);
                if (lineBuffer.length === 4 || idx === recordBuffer.length - 1) {
                    const div = document.createElement('div');
                    lineBuffer.forEach(s => div.appendChild(s));
                    display.appendChild(div);
                    lineBuffer = [];
                }
            } else {
                span.className += ' mx-2';
                if (idx > 0 && recordBuffer[idx].time === recordBuffer[idx - 1].time) {
                    span.className += ' -ml-1'; 
                    span.textContent = item.label + ' '; 
                } else {
                    span.textContent = item.label;
                    span.className += ' mr-2';
                }
                display.appendChild(span);
                if ((idx + 1) % 4 === 0 && (idx + 1) !== recordBuffer.length) {
                    const spacer = document.createElement('span');
                    spacer.innerHTML = '&nbsp;&nbsp;'; 
                    display.appendChild(spacer);
                }
            }
        });
        if (isLandscape) display.scrollTop = display.scrollHeight;
        else display.scrollLeft = display.scrollWidth;
        const isDisabled = recordBuffer.length === 0;
        document.getElementById('playRecord').disabled = isDisabled || isPlaying;
        document.getElementById('exportWav').disabled = isDisabled || isPlaying;
        document.getElementById('saveCurrent').disabled = isDisabled; 
    }

    function playRecording() {
        if (recordBuffer.length === 0 || isPlaying) return;
        if (!ctx) initAudio();
        masterGain.gain.setValueAtTime(0.9, ctx.currentTime); 
        isPlaying = true;
        const playBtn = document.getElementById('playRecord');
        playBtn.innerHTML = '<span>â¹</span> åœæ­¢';
        playBtn.classList.replace('bg-green-700', 'bg-red-700');
        playBtn.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
        document.getElementById('exportWav').disabled = true;
        const now = ctx.currentTime; 
        const startTime = now + 0.1; 
        recordBuffer.forEach((item, idx) => {
            const offsetSeconds = item.time / 1000; 
            const playTime = startTime + offsetSeconds;
            const freq = scaleNotes[item.noteIndex].freq;
            playTone(freq, playTime);
            const delayMs = item.time + 100; 
            const t1 = setTimeout(() => {
                triggerNote(item.noteIndex, null); 
                const span = document.getElementById(`note-span-${idx}`);
                if (span) {
                    span.classList.add('playing-highlight');
                    span.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    setTimeout(() => span.classList.remove('playing-highlight'), 200);
                }
            }, delayMs);
            playbackTimeouts.push(t1);
        });
        const lastNoteTime = recordBuffer[recordBuffer.length - 1].time;
        const endTimeout = setTimeout(stopPlayback, lastNoteTime + 500); 
        playbackTimeouts.push(endTimeout);
    }

    function stopPlayback() {
        if (!ctx || !masterGain) return;
        masterGain.gain.cancelScheduledValues(ctx.currentTime);
        masterGain.gain.setValueAtTime(0, ctx.currentTime);
        playbackTimeouts.forEach(t => clearTimeout(t));
        playbackTimeouts = [];
        isPlaying = false;
        const playBtn = document.getElementById('playRecord');
        playBtn.innerHTML = '<span>â–¶</span> æ’­æ”¾';
        playBtn.classList.replace('bg-red-700', 'bg-green-700');
        playBtn.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
        setTimeout(() => {
             masterGain.gain.setValueAtTime(0.9, ctx.currentTime);
        }, 100);
        document.getElementById('exportWav').disabled = recordBuffer.length === 0;
        updateRecordDisplay(); 
    }

    // --- å’Œå¼¦è¼”åŠ©åŠŸèƒ½ ---

    function highlightChord(chord, isPlay = true) {
        const allFields = document.querySelectorAll('.note-field');
        
        // 1. æ¸…é™¤èˆŠçš„é«˜äº®
        allFields.forEach(el => el.classList.remove('chord-highlight'));
        currentChordHighlight = null;

        if (!chord) return; // å¦‚æœæ²’æœ‰å‚³å…¥å’Œå¼¦ï¼Œç›´æ¥çµæŸ (æ¸…é™¤æ¨¡å¼)

        currentChordHighlight = chord;
        let chordFrequencies = [];

        // 2. é«˜äº®å’Œå¼¦çµ„æˆçš„éŸ³ç¬¦
        chord.labels.forEach(label => {
            const noteElement = Array.from(allFields).find(el => el.dataset.label === label);
            if (noteElement) {
                noteElement.classList.add('chord-highlight');
                const noteIndex = parseInt(noteElement.dataset.index);
                chordFrequencies.push(scaleNotes[noteIndex].freq);
            }
        });

        // 3. æ¼”å¥å’Œå¼¦ (å¦‚æœéœ€è¦)
        if (isPlay && chordFrequencies.length > 0) {
            if (!ctx) initAudio();
            chordFrequencies.forEach(freq => playTone(freq));
            showToast(`æ¼”å¥: ${chord.name}`);
        }
    }

    function renderChordList() {
        const listDiv = document.getElementById('chordList');
        listDiv.innerHTML = '';

        CHORD_DATA.forEach(chord => {
            const button = document.createElement('button');
            button.className = 'text-xs px-2 py-1 rounded bg-emerald-700 hover:bg-emerald-600 transition border border-emerald-600 text-white';
            button.textContent = chord.name;
            button.onclick = () => {
                // å¦‚æœé»æ“Šç•¶å‰é«˜äº®çš„æŒ‰éˆ•ï¼Œå‰‡æ¸…é™¤é«˜äº®
                if (currentChordHighlight === chord) {
                    highlightChord(null);
                } else {
                    highlightChord(chord, true);
                }
            };
            listDiv.appendChild(button);
        });
    }


    // --- Local Storage Functions ---

    function loadScores() {
        const data = localStorage.getItem(STORAGE_KEY);
        try {
            savedScores = data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Error loading scores:", e);
            savedScores = [];
        }
        renderSavedScoresList();
    }

    function saveCurrentScore() {
        if (recordBuffer.length === 0) {
            showToast('ç›®å‰è¨˜éŒ„ç‚ºç©ºï¼Œç„¡æ³•å„²å­˜ï¼');
            return;
        }

        const scoreName = `ç·´ç¿’ ${new Date().toLocaleTimeString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}`;
        
        savedScores.push({
            id: Date.now(),
            name: scoreName,
            buffer: JSON.parse(JSON.stringify(recordBuffer)) 
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedScores));
        showToast(`âœ… è¨˜éŒ„ "${scoreName}" å·²å„²å­˜ï¼`);
        renderSavedScoresList();
    }

    function loadSavedScore(id) {
        const score = savedScores.find(s => s.id === id);
        if (score) {
            recordBuffer = JSON.parse(JSON.stringify(score.buffer)); 
            recordStartTime = score.buffer[0] ? score.buffer[0].time : 0;
            lastRecordTime = score.buffer.length > 0 ? score.buffer[score.buffer.length - 1].time : 0;
            updateRecordDisplay();
            showToast(`âœ… å·²è¼‰å…¥è¨˜éŒ„: ${score.name}`);
        }
    }

    function deleteSavedScore(id) {
        // ç›´æ¥åˆªé™¤ï¼Œé¿å…ä½¿ç”¨ confirm()
        savedScores = savedScores.filter(s => s.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedScores));
        showToast('ğŸ—‘ï¸ è¨˜éŒ„å·²åˆªé™¤ï¼');
        renderSavedScoresList();
    }
    
    function renderSavedScoresList() {
        const listDiv = document.getElementById('savedRecordsList');
        listDiv.innerHTML = '';

        if (savedScores.length === 0) {
            listDiv.innerHTML = '<p class="text-xs text-gray-600 pt-2">ç›®å‰æ²’æœ‰å„²å­˜çš„è¨˜éŒ„ã€‚</p>';
            return;
        }

        savedScores.slice().reverse().forEach(score => {
            const el = document.createElement('div');
            el.className = 'flex justify-between items-center py-1 border-b border-gray-800 last:border-b-0 group';
            el.innerHTML = `
                <span class="text-xs text-white truncate w-2/3 cursor-pointer hover:text-amber-400 transition" 
                      data-id="${score.id}" title="${score.name}">
                    ${score.name} (${score.buffer.length} notes)
                </span>
                <div class="flex gap-1">
                    <button class="text-xs text-green-400 hover:text-green-300 transition px-1" 
                            onclick="loadSavedScore(${score.id})" title="è¼‰å…¥">
                        è¼‰å…¥
                    </button>
                    <button class="text-xs text-red-500 hover:text-red-400 transition px-1" 
                            onclick="deleteSavedScore(${score.id})" title="åˆªé™¤">
                        åˆªé™¤
                    </button>
                </div>
            `;
            listDiv.appendChild(el);
        });
    }

    function toggleSavedRecords() {
        isRecordsListVisible = !isRecordsListVisible;
        const section = document.getElementById('savedRecordsSection');
        const button = document.getElementById('openRecords');

        if (isRecordsListVisible) {
            section.style.maxHeight = '500px'; 
            section.style.opacity = '1';
            section.style.pointerEvents = 'auto';
            button.classList.replace('bg-gray-500', 'bg-gray-400');
        } else {
            section.style.maxHeight = '0'; 
            section.style.opacity = '0';
            section.style.pointerEvents = 'none';
            button.classList.replace('bg-gray-400', 'bg-gray-500');
        }
    }

    // --- Utility Functions (WAV encoding, unchanged) ---
    function floatTo16BitPCM(output, offset, input) { 
        for (let i = 0; i < input.length; i++, offset += 2) {
            let s = Math.max(-1, Math.min(1, input[i]));
            output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        }
    }
    function writeString(view, offset, string) { 
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }
    function encodeWAV(samples, sampleRate) {
        const buffer = new ArrayBuffer(44 + samples.length * 2);
        const view = new DataView(buffer);
        writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + samples.length * 2, true); writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); 
        view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
        writeString(view, 36, 'data'); view.setUint32(40, samples.length * 2, true);
        floatTo16BitPCM(view, 44, samples);
        return view;
    }

    async function exportRecording() {
        if (recordBuffer.length === 0 || isPlaying) { showToast('è«‹å…ˆéŒ„è£½ä¸€æ®µæ¨‚è­œï¼'); return; }
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.opacity = '1'; loadingOverlay.style.pointerEvents = 'auto';
        try {
            const lastNoteTime = recordBuffer[recordBuffer.length - 1].time;
            const durationSeconds = (lastNoteTime / 1000) + 2.0; 
            const sampleRate = 44100;
            const bufferLength = Math.ceil(durationSeconds * sampleRate);
            const offlineCtx = new OfflineAudioContext(1, bufferLength, sampleRate);
            const offlineCompressor = offlineCtx.createDynamicsCompressor();
            offlineCompressor.threshold.setValueAtTime(-20, 0);
            offlineCompressor.ratio.setValueAtTime(8, 0);
            offlineCompressor.connect(offlineCtx.destination);
            const offlineMasterGain = offlineCtx.createGain();
            offlineMasterGain.gain.value = 0.9;
            offlineMasterGain.connect(offlineCompressor);
            const startTime = 0.1; 
            recordBuffer.forEach((item) => {
                const offsetSeconds = item.time / 1000;
                const playTime = startTime + offsetSeconds;
                const freq = scaleNotes[item.noteIndex].freq;
                playTone(freq, playTime, offlineCtx, offlineMasterGain);
            });
            const renderedBuffer = await offlineCtx.startRendering();
            const audioData = renderedBuffer.getChannelData(0);
            const wavDataView = encodeWAV(audioData, sampleRate);
            const blob = new Blob([wavDataView], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Handpan_Record_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('âœ… WAV æª”æ¡ˆåŒ¯å‡ºæˆåŠŸï¼');
        } catch (error) {
            console.error('åŒ¯å‡ºéŸ³è¨ŠéŒ¯èª¤:', error);
            showToast(`âŒ åŒ¯å‡ºå¤±æ•—: ${error.message}`);
        } finally {
            loadingOverlay.style.opacity = '0';
            loadingOverlay.style.pointerEvents = 'none';
        }
    }

    function copyToClipboard() {
        if (recordBuffer.length === 0) { showToast('æ²’æœ‰å¯è¤‡è£½çš„è¨˜éŒ„'); return; }
        let text = "";
        recordBuffer.forEach((item, idx) => {
            text += item.label;
            if (idx + 1 < recordBuffer.length && recordBuffer[idx].time === recordBuffer[idx + 1].time) {
            } else if ((idx + 1) % 4 === 0) {
                text += " | ";
            } else {
                text += " ";
            }
        });
        text = text.trim();
        if (text.endsWith('|')) text = text.slice(0, -1).trim();
        navigator.clipboard.writeText(text).then(() => {
            showToast('æ¨‚è­œå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }).catch(() => {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('æ¨‚è­œå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼(å…¼å®¹æ¨¡å¼)');
            } catch (err) {
                showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            }
        });
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.opacity = '1';
        setTimeout(() => toast.style.opacity = '0', 2000);
    }

    // --- Event Listeners ---
    document.getElementById('saveCurrent').addEventListener('click', saveCurrentScore);
    document.getElementById('openRecords').addEventListener('click', toggleSavedRecords);
    
    document.getElementById('playRecord').addEventListener('click', () => {
        if (isPlaying) stopPlayback();
        else playRecording();
    });

    document.getElementById('copyRecord').addEventListener('click', copyToClipboard);
    document.getElementById('exportWav').addEventListener('click', exportRecording);

    document.getElementById('clearRecord').addEventListener('click', () => {
        if (isPlaying) stopPlayback();
        recordBuffer = [];
        recordStartTime = 0;
        lastRecordTime = 0; 
        document.getElementById('notationDisplay').innerHTML = '<span class="text-gray-500 text-sm italic absolute top-0 left-0">é»æ“ŠéŸ³éšé–‹å§‹è¨˜éŒ„...</span>';
        updateRecordDisplay();
    });

    document.getElementById('toggleLabels').addEventListener('click', (e) => {
        isLabelsVisible = !isLabelsVisible;
        e.target.textContent = isLabelsVisible ? 'éš±è—æ¨™ç±¤' : 'é¡¯ç¤ºæ¨™ç±¤';
        renderHandpan();
    });

    const overlay = document.getElementById('startOverlay');
    const startAudio = () => {
        initAudio();
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 500);
    };
    overlay.addEventListener('click', startAudio);
    overlay.addEventListener('touchstart', (e) => { e.preventDefault(); startAudio(); });

    window.onload = () => {
        loadScores(); // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚è¼‰å…¥æ‰€æœ‰è¨˜éŒ„
        renderHandpan();
        renderChordList(); // æ¸²æŸ“å’Œå¼¦åˆ—è¡¨
        window.addEventListener('resize', () => {
            adjustHandpanSize();
            updateRecordDisplay();
        });
        updateRecordDisplay(); 
    };

</script>
</body>
</html>

