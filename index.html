<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è™›æ“¬æ‰‹ç¢Ÿé¼“ç·´ç¿’ (Virtual Handpan)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* éš±è—æ²è»¸ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
            font-family: "Noto Sans TC", sans-serif;
            background-color: #111; 
            height: 100vh;
            width: 100vw;
            overflow: hidden; 
        }

        .header-bg {
             background-color: rgba(20, 20, 20, 0.9);
             backdrop-filter: blur(8px);
             -webkit-backdrop-filter: blur(8px);
             position: absolute;
             top: 0;
             width: 100%;
             z-index: 50; 
        }

        /* --- æ‰‹ç¢Ÿæœ¬é«” --- */
        .handpan-body {
            background: radial-gradient(circle at 40% 40%, #6e6e6e 0%, #3a3a3a 40%, #1f1f1f 85%, #0d0d0d 100%);
            box-shadow: 
                0 25px 60px rgba(0, 0, 0, 0.9),       
                inset 0 2px 3px rgba(255, 255, 255, 0.2), 
                inset 0 -10px 20px rgba(0, 0, 0, 0.8);    
            border-radius: 50%;
            position: relative;
            transition: transform 0.1s ease;
            z-index: 20; 
            width: 85vmin;
            height: 85vmin;
            max-width: 650px;
            max-height: 650px;
        }

        /* --- éŸ³èˆŒç†±å€ --- */
        .note-field {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(145deg, #2a2a2a, #3d3d3d);
            box-shadow: 
                inset 1px 1px 3px rgba(0, 0, 0, 0.9), 
                inset -1px -1px 2px rgba(255, 255, 255, 0.05),
                2px 2px 4px rgba(0, 0, 0, 0.4); 
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fbbf24; 
            font-weight: bold;
            transition: all 0.05s;
            transform: translate(-50%, -50%);
            text-shadow: 0 1px 2px rgba(0,0,0,0.9); 
            line-height: 1;
            z-index: 25;
            -webkit-tap-highlight-color: transparent;
        }

        .note-field.tone-field { width: 22%; height: 22%; }
        .note-num { font-size: 1.6rem; color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.2); }
        .note-name { font-size: 0.75rem; color: #888; margin-top: 2px; }

        .ding {
            position: absolute; top: 50%; left: 50%; 
            width: 28%; height: 28%; 
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #888, #222);
            box-shadow: 0 10px 20px rgba(0,0,0,0.6), inset 0 1px 5px rgba(255,255,255,0.3);
            z-index: 30;
        }
        .ding .note-num { font-size: 2.4rem; color: #fff; }
        .ding .note-name { color: #fbbf24; }

        .note-field.active, .ding.active {
            transform: translate(-50%, -50%) scale(0.96);
            background: linear-gradient(145deg, #444, #555);
            box-shadow: inset 0 0 15px rgba(251, 191, 36, 0.4); 
        }

        .note-field.chord-highlight {
            background: linear-gradient(145deg, #383838, #5a5a5a);
            box-shadow: 0 0 10px #34d399, inset 0 0 8px rgba(52, 211, 163, 0.8);
            transform: translate(-50%, -50%) scale(1.02);
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        }
        .ding.chord-highlight {
            box-shadow: 0 0 10px #34d399, inset 0 0 8px rgba(52, 211, 163, 0.8);
            transform: translate(-50%, -50%) scale(1.02);
        }

        .note-field.practice-target {
            box-shadow: 0 0 0 4px #3b82f6, 0 0 20px #3b82f6; 
            z-index: 40;
            animation: pulse-target 1.5s infinite;
        }
        @keyframes pulse-target {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.7); }
            70% { transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0px rgba(59, 130, 246, 0); }
        }
        
        /* --- Bottom Sheet --- */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 85vh; 
            background-color: #1f2937; 
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.6);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            z-index: 45;
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
        }

        .bottom-sheet-drag-handle {
            width: 40px;
            height: 5px;
            background-color: #4b5563;
            border-radius: 3px;
            margin: 8px auto 4px; 
            cursor: pointer;
        }

        .overlay-dim {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 40;
        }
        .overlay-dim.is-visible { opacity: 1; pointer-events: auto; }

        .score-note { font-size: 1.25rem; line-height: 1.8; display: inline-block; }
        .playing-highlight { color: #ef4444 !important; font-weight: 900 !important; transform: scale(1.2); }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #fbbf24;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="w-screen flex flex-col items-center justify-start text-gray-200">

    <!-- Header -->
    <div class="w-full p-3 header-bg flex justify-between items-center shadow-lg shrink-0 h-[60px]">
        <h1 class="text-lg font-bold text-amber-500 tracking-wider">Handpan <span class="text-xs text-gray-400 hidden sm:inline">D Kurd 10</span></h1>
        <div class="flex gap-2">
            <button id="toggleLabels" class="bg-gray-700 hover:bg-gray-600 text-xs px-3 py-1 rounded transition border border-gray-600">
                éš±è—æ¨™ç±¤
            </button>
        </div>
    </div>

    <!-- Handpan Area -->
    <div id="handpan-container" class="w-full flex-grow flex items-start justify-center relative overflow-hidden p-4 pt-[85px] md:pt-20 md:items-center">
        <div id="handpan" class="handpan-body shrink-0">
            <div class="ding note-field" data-note-index="0"></div>
        </div>
    </div>
    
    <!-- Overlay -->
    <div id="overlayDim" class="overlay-dim"></div>

    <!-- Bottom Sheet -->
    <div id="recordSidebar" class="bottom-sheet" style="transform: translateY(calc(100% - 280px));">
        <div class="bottom-sheet-drag-handle" id="dragHandle"></div>
        
        <div class="bottom-sheet-content p-4 pt-0">
            
            <!-- æ­Œæ›²èˆ‡å’Œå¼¦ -->
            <div class="mb-2 border-b border-gray-700 pb-2">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest">Songs (Tutorial)</span>
                    <span class="text-[10px] text-gray-500 md:hidden">â†‘ ä¸Šæ‹‰å±•é–‹</span>
                </div>
                
                <!-- æ­Œæ›²é¸å–® -->
                <div class="flex gap-2 mb-2">
                    <select id="songSelect" class="bg-gray-800 text-white text-xs rounded border border-gray-600 px-2 py-1 flex-grow focus:outline-none focus:border-emerald-500">
                        <option value="" disabled selected>-- é¸æ“‡ç·´ç¿’æ›² --</option>
                    </select>
                    <button id="demoSong" class="bg-emerald-700 hover:bg-emerald-600 text-white text-xs px-3 py-1 rounded whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
                        â–¶ ç¤ºç¯„
                    </button>
                    <button id="practiceSong" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
                        ğŸ¯ è·Ÿå½ˆ
                    </button>
                </div>

                <!-- å’Œå¼¦æŒ‰éˆ• -->
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest">Chords</span>
                </div>
                <div id="chordList" class="flex flex-wrap gap-1 mt-0.5"></div>
            </div>

            <!-- è¨˜éŒ„æ§åˆ¶ -->
            <div class="flex flex-wrap justify-between items-center mb-2 gap-2 shrink-0">
                <span class="text-[10px] text-amber-500 font-bold uppercase tracking-widest">Record</span>
                <div class="flex gap-2">
                    <button id="saveCurrent" class="text-xs bg-yellow-600 hover:bg-yellow-500 text-black px-2 py-1 rounded flex items-center gap-1 disabled:opacity-50">
                        <span>ğŸ’¾</span> å„²å­˜
                    </button>
                    <button id="openRecords" class="text-xs bg-gray-500 hover:bg-gray-400 text-white px-2 py-1 rounded flex items-center gap-1">
                        <span>ğŸ“–</span> åˆ—è¡¨
                    </button>
                </div>
            </div>
            
            <!-- æ’­æ”¾èˆ‡åŒ¯å‡º -->
            <div class="flex flex-wrap justify-between items-center mb-2 border-b border-gray-700 pb-2 gap-2 shrink-0">
                <div class="flex gap-1.5 w-full justify-between">
                    <button id="playRecord" class="text-xs bg-green-700 hover:bg-green-600 text-white px-3 py-1.5 rounded flex-1 flex justify-center items-center gap-1 disabled:opacity-50">
                        <span>â–¶</span> æ’­æ”¾
                    </button>
                    <button id="exportWav" class="text-xs bg-purple-700 hover:bg-purple-600 text-white px-3 py-1.5 rounded flex-1 flex justify-center items-center gap-1 disabled:opacity-50">
                        <span>ğŸ“¥</span> WAV
                    </button>
                    <button id="copyRecord" class="text-xs bg-blue-700 hover:bg-blue-600 text-white px-3 py-1.5 rounded flex-1 flex justify-center items-center gap-1">
                        <span>ğŸ“‹</span>
                    </button>
                    <button id="clearRecord" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1.5 rounded flex-1 flex justify-center items-center">
                        æ¸…é™¤
                    </button>
                </div>
            </div>

            <!-- ç°¡è­œé¡¯ç¤º -->
            <div id="notationDisplay" class="font-mono tracking-wider text-white overflow-x-auto whitespace-nowrap scrollbar-hide relative border-b border-gray-700 pb-2 min-h-[40px] mb-2 bg-gray-800/50 rounded px-2 pt-1">
                <span id="notationPlaceholder" class="text-gray-500 text-sm italic absolute top-1 left-2">é»æ“ŠéŸ³éšé–‹å§‹è¨˜éŒ„...</span>
            </div>
            
            <!-- æ­·å²è¨˜éŒ„åˆ—è¡¨ -->
            <div id="savedRecordsSection" class="overflow-y-auto scrollbar-hide">
                 <h3 class="text-sm font-bold text-gray-400 mb-2 border-b border-gray-800 pb-1">æ­·å²è¨˜éŒ„</h3>
                 <div id="savedRecordsList">
                    <p class="text-xs text-gray-600">ç›®å‰æ²’æœ‰å„²å­˜çš„è¨˜éŒ„ã€‚</p>
                 </div>
                 <p class="text-gray-600 text-[10px] mt-4 text-center w-full">Low Latency Audio Engine Active</p>
            </div>
        </div>
    </div>

    <div id="startOverlay" class="fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-50 cursor-pointer touch-manipulation">
        <div class="text-amber-500 text-6xl mb-4 animate-pulse">â™«</div>
        <h2 class="text-2xl text-white font-bold mb-2">é»æ“Šå•Ÿç”¨éŸ³æ•ˆ</h2>
        <p class="text-gray-400 text-sm mb-8">å•Ÿå‹•ä½å»¶é²éŸ³è¨Šå¼•æ“</p>
        <div class="text-xs text-gray-600 px-8 text-center">
            æ¨è–¦ä½¿ç”¨æœ‰ç·šè€³æ©Ÿé«”é©—æœ€ä½³éŸ³è³ª
        </div>
    </div>

    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm transition-opacity opacity-0 pointer-events-none z-50">
        è¨Šæ¯
    </div>
    
    <div id="loadingOverlay" class="fixed inset-0 bg-black/70 flex flex-col items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl text-white">è™•ç†ä¸­...</h2>
    </div>

<script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const OfflineAudioContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;
    const STORAGE_KEY = 'HANDPAN_SAVED_SCORES';

    let ctx = null;
    let masterGain = null;
    let compressor = null;
    let isAudioInitialized = false;
    let savedScores = [];
    let isPlaying = false;
    let playbackTimeouts = [];
    let currentChordHighlight = null; 
    let recordBuffer = []; 
    let recordStartTime = 0;
    let lastRecordTime = 0;
    const CHORD_TOLERANCE_MS = 50; 
    let isSheetExpanded = false;

    // --- è·Ÿå½ˆæ¨¡å¼è®Šæ•¸ ---
    let isPracticeMode = false;
    let currentPracticeSong = null;
    let practiceNoteIndex = 0;

    const CHORD_DATA = [
        { name: "D-min", labels: ["D", "1", "4", "6", "8"] },
        { name: "Bb-maj", labels: ["D", "2", "4", "6"] },
        { name: "G-min", labels: ["D", "2", "4", "7"] },
        { name: "A-min", labels: ["1", "3", "5", "8", "9"] },
        { name: "C-maj", labels: ["3", "5", "7", "9"] },
        { name: "F-maj", labels: ["1", "3", "6", "8", "9"] },
    ];

    // æ­Œæ›²è³‡æ–™åº« (å«ç¯€å¥)
    const SONGS_DATA = [
        {
            name: "æœˆå…‰ (Moonlight)",
            bpm: 120, // é è¨­é€Ÿåº¦
            notes: [
                "1","4","6",  "1","4","6",  "1","4","6",  "1","4","6",
                "2","4","6",  "2","4","6",  "2","4","7",  "2","4","7",
                "1","4","7",  "1","4","6",  "1","4","5",  "1","4","5",
                "D","1","4",  "1","4","6",  "1","4","6",  "8","4","6","8",
                "8","4","7",  "2","4","7",  "2","4","7",  "8","4","7",
                "8","4","6",  "1","4","6",  "7","4","7",  "2","4","7",
                "8","3","6",  "1","3","6",  "7","3","5",  "9","3","5",
                "6","3","6",  "1","3","6",  "1","3","6",  "1","3","6",
                "6","3","6",  "3","6","8",  "6","8","9",  "6","1","3"
            ]
        },
        {
            name: "éˆ´å…’éŸ¿å®å™¹ (Jingle Bells)",
            bpm: 180, // è¼•å¿«
            notes: [
                {label:"3",beat:1}, {label:"3",beat:1}, {label:"3",beat:2},
                {label:"3",beat:1}, {label:"3",beat:1}, {label:"3",beat:2},
                {label:"3",beat:1}, {label:"5",beat:1}, {label:"1",beat:1}, {label:"2",beat:1}, {label:"3",beat:4},
                {label:"4",beat:1}, {label:"4",beat:1}, {label:"4",beat:1.5}, {label:"4",beat:0.5}, {label:"4",beat:1}, {label:"3",beat:1}, {label:"3",beat:1}, {label:"3",beat:0.5}, {label:"3",beat:0.5},
                {label:"3",beat:1}, {label:"2",beat:1}, {label:"2",beat:1}, {label:"3",beat:1}, {label:"2",beat:2}, {label:"5",beat:2}
            ]
        },
        {
            name: "æœˆäº®ä»£è¡¨æˆ‘çš„å¿ƒ",
            bpm: 90, // æ·±æƒ…æ…¢æ¿
            notes: [
                // Intro
                {label:"5",beat:1}, {label:"6",beat:1}, {label:"8",beat:2},
                {label:"5",beat:1}, {label:"6",beat:1}, {label:"8",beat:2},
                {label:"5",beat:1}, {label:"3",beat:1}, {label:"2",beat:1}, {label:"1",beat:1}, {label:"2",beat:4},
                // Verse 1
                {label:"5",beat:1.5}, {label:"3",beat:0.5}, {label:"5",beat:2}, // ä½ å•æˆ‘...
                {label:"1",beat:1}, {label:"7",beat:1}, {label:"6",beat:1}, {label:"5",beat:1}, // æ„›ä½ æœ‰å¤šæ·±
                {label:"5",beat:1}, {label:"4",beat:1}, {label:"3",beat:1}, {label:"2",beat:1}, // æˆ‘æ„›ä½ æœ‰...
                {label:"2",beat:4}, // å¹¾åˆ†
                // Verse 2
                {label:"3",beat:1.5}, {label:"1",beat:0.5}, {label:"3",beat:2}, // æˆ‘çš„æƒ…...
                {label:"5",beat:1}, {label:"4",beat:1}, {label:"3",beat:1}, {label:"2",beat:1}, // ä¹ŸçœŸ
                {label:"2",beat:1}, {label:"1",beat:1}, {label:"D",beat:1}, {label:"1",beat:1}, // æœˆäº®ä»£è¡¨
                {label:"1",beat:4} // æˆ‘çš„å¿ƒ
            ]
        }
    ];

    function getPos(deg, radius = 36) { 
        const rad = deg * (Math.PI / 180);
        return { top: 50 + radius * Math.sin(rad), left: 50 + radius * Math.cos(rad) };
    }
    
    const scaleNotes = [
        { note: "D3", freq: 146.83, label: "D", pos: { top: 50, left: 50 }, type: 'center-note' }, 
        { note: "A3", freq: 220.00, label: "1", pos: getPos(90), rotate: 0 },
        { note: "Bb3", freq: 233.08, label: "2", pos: getPos(130), rotate: 40 },
        { note: "C4", freq: 261.63, label: "3", pos: getPos(50), rotate: -40 },
        { note: "D4", freq: 293.66, label: "4", pos: getPos(170), rotate: 80 },
        { note: "E4", freq: 329.63, label: "5", pos: getPos(10), rotate: -80 },
        { note: "F4", freq: 349.23, label: "6", pos: getPos(210), rotate: 120 },
        { note: "G4", freq: 392.00, label: "7", pos: getPos(330), rotate: -120 },
        { note: "A4", freq: 440.00, label: "8", pos: getPos(250), rotate: 160 },
        { note: "C5", freq: 523.25, label: "9", pos: getPos(290), rotate: -160 } 
    ];

    let isLabelsVisible = true;

    function initAudio() {
        if (ctx) return;
        ctx = new AudioContext({ latencyHint: 'interactive', sampleRate: 44100 });
        compressor = ctx.createDynamicsCompressor();
        compressor.threshold.setValueAtTime(-20, ctx.currentTime);
        compressor.ratio.setValueAtTime(8, ctx.currentTime);
        masterGain = ctx.createGain();
        masterGain.gain.value = 0.9;
        compressor.connect(masterGain);
        masterGain.connect(ctx.destination);
        const buffer = ctx.createBuffer(1, 1, 22050);
        const source = ctx.createBufferSource();
        source.buffer = buffer;
        source.connect(ctx.destination);
        source.start(0);
        isAudioInitialized = true;
        if (ctx.state === 'suspended') ctx.resume();
    }

    function playTone(freq, when = 0, audioContext = ctx, destination = compressor) {
        if (!audioContext) return;
        const now = when || audioContext.currentTime;
        const attackTime = 0.005; 
        const oscs = [
            { type: 'sine', mult: 1, gain: 0.6, decay: 3.5 },
            { type: 'sine', mult: 2, gain: 0.3, decay: 2.0 },
            { type: 'sine', mult: 3, gain: 0.15, decay: 1.5 },
            { type: 'triangle', mult: 4.5, gain: 0.05, decay: 0.05, isClick: true }
        ];
        oscs.forEach(o => {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = o.type;
            osc.frequency.setValueAtTime(freq * o.mult, now);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(o.gain, now + attackTime);
            gain.gain.exponentialRampToValueAtTime(0.001, now + o.decay);
            osc.connect(gain);
            gain.connect(destination);
            osc.start(now);
            osc.stop(now + 4);
        });
    }

    function renderHandpan() {
        const container = document.getElementById('handpan');
        const ding = container.querySelector('.ding');
        container.innerHTML = ''; 
        const newDing = ding.cloneNode(true);
        container.appendChild(newDing);
        setupNoteElement(newDing, scaleNotes[0], 0);

        scaleNotes.slice(1).forEach((n, i) => {
            const el = document.createElement('div');
            el.className = 'note-field tone-field';
            el.style.left = `${n.pos.left}%`;
            el.style.top = `${n.pos.top}%`;
            if (n.rotate !== undefined) el.style.transform = `translate(-50%, -50%) rotate(${n.rotate}deg)`;
            container.appendChild(el);
            setupNoteElement(el, n, i + 1);
        });
        adjustHandpanSize();
        if (currentChordHighlight) highlightChord(currentChordHighlight, false);
    }

    function setupNoteElement(el, n, index) {
        const textRotate = n.rotate ? -n.rotate : 0;
        el.innerHTML = isLabelsVisible 
            ? `<div class="pointer-events-none" style="transform: rotate(${textRotate}deg)">
                 <div class="note-num">${n.label}</div>
                 <div class="note-name">${n.note}</div>
               </div>` 
            : '';
        const playHandler = (e) => {
            if (e.type === 'touchstart') e.preventDefault(); 
            triggerNote(index, el);
        };
        el.addEventListener('touchstart', playHandler, { passive: false });
        el.addEventListener('mousedown', playHandler);
        el.dataset.label = n.label; 
        el.dataset.index = index;
    }

    function triggerNote(index, element) {
        if (!isAudioInitialized) initAudio();
        if (ctx && ctx.state === 'suspended') ctx.resume();
        
        if (isPlaying && !isPracticeMode) return; 

        const noteData = scaleNotes[index];
        playTone(noteData.freq);

        if (element) {
            element.classList.add('active');
            setTimeout(() => element.classList.remove('active'), 100);
        } else {
            const allFields = document.querySelectorAll('.note-field');
            const target = allFields[index]; 
            if(target) {
                target.classList.add('active');
                setTimeout(() => target.classList.remove('active'), 100);
            }
        }

        // --- è·Ÿå½ˆæ¨¡å¼é‚è¼¯ ---
        if (isPracticeMode && currentPracticeSong) {
            const targetNote = currentPracticeSong.notes[practiceNoteIndex];
            const targetLabel = targetNote.label || targetNote; // æ”¯æ´æ–°èˆŠæ ¼å¼
            
            if (noteData.label === targetLabel) {
                practiceNoteIndex++;
                if (practiceNoteIndex >= currentPracticeSong.notes.length) {
                    showToast("ğŸ‰ ç·´ç¿’å®Œæˆï¼");
                    stopPracticeMode();
                } else {
                    highlightPracticeTarget();
                }
            }
        }

        // --- è¨˜éŒ„é‚è¼¯ ---
        const now = Date.now();
        let relativeTime;
        if (recordBuffer.length === 0) {
            recordStartTime = now;
            relativeTime = 0;
        } else {
            if (now - lastRecordTime < CHORD_TOLERANCE_MS) {
                relativeTime = recordBuffer[recordBuffer.length - 1].time;
            } else {
                relativeTime = now - recordStartTime;
            }
        }
        lastRecordTime = now;
        recordBuffer.push({
            label: noteData.label,
            noteIndex: index,
            time: relativeTime
        });
        updateRecordDisplay();
    }

    function adjustHandpanSize() {
        const container = document.getElementById('handpan-container');
        const handpan = document.getElementById('handpan');
        if (!container || !handpan) return;
        
        const bottomSheetHeight = 280; 
        const availableHeight = window.innerHeight - 60 - bottomSheetHeight; 
        const isMobile = window.innerWidth < 768;
        const sizeFactor = isMobile ? 0.95 : 0.9; 

        let size = Math.min(container.clientWidth, availableHeight) * sizeFactor; 
        size = Math.max(size, 260); 
        const finalSize = Math.min(size, 650); 
        
        handpan.style.width = `${finalSize}px`;
        handpan.style.height = `${finalSize}px`;
        
        if (isMobile) {
            container.style.alignItems = 'flex-start'; 
            container.style.paddingTop = '80px'; 
        } else {
            container.style.alignItems = 'center';
            container.style.paddingTop = '16px';
        }
    }

    function updateRecordDisplay() {
        const display = document.getElementById('notationDisplay');
        const placeholder = document.getElementById('notationPlaceholder');
        
        if (recordBuffer.length === 0) {
            display.innerHTML = '';
            if(placeholder) {
                placeholder.style.display = 'block';
                display.appendChild(placeholder);
            } else {
                display.innerHTML = '<span id="notationPlaceholder" class="text-gray-500 text-sm italic absolute top-1 left-2">é»æ“ŠéŸ³éšé–‹å§‹è¨˜éŒ„...</span>';
            }
            return;
        }
        
        display.innerHTML = '';
        recordBuffer.forEach((item, idx) => {
            const span = document.createElement('span');
            span.id = `note-span-${idx}`;
            span.className = 'score-note inline-block font-mono transition-colors duration-100 mx-2';
            span.className += item.label === 'D' ? ' text-amber-400 font-bold' : ' text-white';
            
            if (idx > 0 && recordBuffer[idx].time === recordBuffer[idx - 1].time) {
                span.className = span.className.replace('mx-2', '-ml-1');
                span.textContent = item.label + ' ';
            } else {
                span.textContent = item.label;
            }
            
            display.appendChild(span);
            
            if ((idx + 1) % 4 === 0 && (idx + 1) !== recordBuffer.length) {
                const spacer = document.createElement('span');
                spacer.innerHTML = '&nbsp;'; 
                display.appendChild(spacer);
            }
        });
        display.scrollLeft = display.scrollWidth;
        
        const isDisabled = recordBuffer.length === 0;
        document.getElementById('playRecord').disabled = isDisabled || isPlaying;
        document.getElementById('exportWav').disabled = isDisabled || isPlaying;
        document.getElementById('saveCurrent').disabled = isDisabled; 
    }

    function playRecording() {
        if (recordBuffer.length === 0 || isPlaying) return;
        if (!ctx) initAudio();
        masterGain.gain.setValueAtTime(0.9, ctx.currentTime);
        isPlaying = true;
        const playBtn = document.getElementById('playRecord');
        playBtn.innerHTML = '<span>â¹</span>';
        playBtn.classList.replace('bg-green-700', 'bg-red-700');
        playBtn.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
        document.getElementById('exportWav').disabled = true;
        const now = ctx.currentTime; 
        const startTime = now + 0.1; 
        recordBuffer.forEach((item, idx) => {
            const offsetSeconds = item.time / 1000; 
            const playTime = startTime + offsetSeconds;
            const freq = scaleNotes[item.noteIndex].freq;
            playTone(freq, playTime);
            const delayMs = item.time + 100; 
            const t1 = setTimeout(() => {
                triggerNote(item.noteIndex, null); 
                const span = document.getElementById(`note-span-${idx}`);
                if (span) {
                    span.classList.add('playing-highlight');
                    span.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                    setTimeout(() => span.classList.remove('playing-highlight'), 200);
                }
            }, delayMs);
            playbackTimeouts.push(t1);
        });
        const lastNoteTime = recordBuffer[recordBuffer.length - 1].time;
        const endTimeout = setTimeout(stopPlayback, lastNoteTime + 500); 
        playbackTimeouts.push(endTimeout);
    }

    function stopPlayback() {
        if (!ctx || !masterGain) return;
        masterGain.gain.cancelScheduledValues(ctx.currentTime);
        masterGain.gain.setValueAtTime(0, ctx.currentTime);
        playbackTimeouts.forEach(t => clearTimeout(t));
        playbackTimeouts = [];
        isPlaying = false;
        const playBtn = document.getElementById('playRecord');
        playBtn.innerHTML = '<span>â–¶</span> æ’­æ”¾';
        playBtn.classList.replace('bg-red-700', 'bg-green-700');
        playBtn.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
        setTimeout(() => { masterGain.gain.setValueAtTime(0.9, ctx.currentTime); }, 100);
        document.getElementById('exportWav').disabled = recordBuffer.length === 0;
        updateRecordDisplay(); 
    }

    function highlightChord(chord, isPlay = true) {
        const allFields = document.querySelectorAll('.note-field');
        allFields.forEach(el => el.classList.remove('chord-highlight'));
        currentChordHighlight = null;
        if (!chord) return; 
        currentChordHighlight = chord;
        let chordFrequencies = [];
        chord.labels.forEach(label => {
            const noteElement = Array.from(allFields).find(el => el.dataset.label === label);
            if (noteElement) {
                noteElement.classList.add('chord-highlight');
                const noteIndex = parseInt(noteElement.dataset.index);
                chordFrequencies.push(scaleNotes[noteIndex].freq);
            }
        });
        if (isPlay && chordFrequencies.length > 0) {
            if (!ctx) initAudio();
            chordFrequencies.forEach(freq => playTone(freq));
            showToast(`æ¼”å¥: ${chord.name}`);
        }
    }

    // --- æ­Œæ›²è¼‰å…¥/ç¤ºç¯„/è·Ÿå½ˆ ---
    function initSongSelect() {
        const select = document.getElementById('songSelect');
        if(SONGS_DATA.length === 0) return; 

        SONGS_DATA.forEach((song, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.text = song.name;
            select.appendChild(option);
        });

        const checkSelection = () => {
            const hasSelection = select.value !== "";
            document.getElementById('demoSong').disabled = !hasSelection;
            document.getElementById('practiceSong').disabled = !hasSelection;
        };
        
        select.addEventListener('change', checkSelection);
        checkSelection(); 
    }

    function loadSongForDemo() {
        const select = document.getElementById('songSelect');
        if (!select.value) return;
        const song = SONGS_DATA[select.value];
        
        recordBuffer = [];
        recordStartTime = 0;
        let currentTime = 0;
        // BPM è½‰æ¯«ç§’: (60000 / BPM) = ä¸€æ‹çš„ms
        const beatMs = song.bpm ? (60000 / song.bpm) : 400; 

        song.notes.forEach(note => {
            // å…¼å®¹èˆŠæ ¼å¼ (ç´”å­—ä¸²) å’Œæ–°æ ¼å¼ (ç‰©ä»¶å«ç¯€å¥)
            const label = note.label || note; 
            const beats = note.beat || 1; 
            
            const noteIndex = scaleNotes.findIndex(n => n.label === label);
            if (noteIndex !== -1) {
                recordBuffer.push({
                    label: label,
                    noteIndex: noteIndex,
                    time: currentTime
                });
            }
            // ç´¯åŠ æ™‚é–“ï¼šæ‹æ•¸ * æ¯æ‹æ™‚é•·
            currentTime += beats * beatMs;
        });
        
        updateRecordDisplay();
        playRecording();
        showToast(`æ­£åœ¨ç¤ºç¯„: ${song.name}`);
    }

    function startPracticeMode() {
        const select = document.getElementById('songSelect');
        if (!select.value) return;
        const song = SONGS_DATA[select.value];

        stopPlayback(); 
        isPracticeMode = true;
        currentPracticeSong = song;
        practiceNoteIndex = 0;
        
        recordBuffer = [];
        updateRecordDisplay();
        
        showToast("ğŸ¯ è·Ÿå½ˆæ¨¡å¼é–‹å§‹ï¼è«‹è·Ÿéš¨è—è‰²æ¸¸æ¨™");
        highlightPracticeTarget();
        
        document.getElementById('songSelect').disabled = true;
        document.getElementById('demoSong').disabled = true;
        document.getElementById('practiceSong').innerHTML = "âŒ çµæŸ";
        document.getElementById('practiceSong').onclick = stopPracticeMode;
        document.getElementById('practiceSong').classList.replace('bg-blue-600', 'bg-red-600');
        document.getElementById('practiceSong').classList.replace('hover:bg-blue-500', 'hover:bg-red-500');
    }

    function stopPracticeMode() {
        isPracticeMode = false;
        currentPracticeSong = null;
        practiceNoteIndex = 0;
        
        const allFields = document.querySelectorAll('.note-field');
        allFields.forEach(el => el.classList.remove('practice-target'));

        document.getElementById('songSelect').disabled = false;
        document.getElementById('demoSong').disabled = false;
        
        const btn = document.getElementById('practiceSong');
        btn.innerHTML = "ğŸ¯ è·Ÿå½ˆ";
        btn.onclick = startPracticeMode;
        btn.classList.replace('bg-red-600', 'bg-blue-600');
        btn.classList.replace('hover:bg-red-500', 'hover:bg-blue-500');
    }

    function highlightPracticeTarget() {
        const allFields = document.querySelectorAll('.note-field');
        allFields.forEach(el => el.classList.remove('practice-target'));
        
        if (!currentPracticeSong || practiceNoteIndex >= currentPracticeSong.notes.length) return;

        const targetNote = currentPracticeSong.notes[practiceNoteIndex];
        const targetLabel = targetNote.label || targetNote;
        
        const targetEl = Array.from(allFields).find(el => el.dataset.label === targetLabel);
        
        if (targetEl) {
            targetEl.classList.add('practice-target');
        }
    }

    function renderChordList() {
        const listDiv = document.getElementById('chordList');
        listDiv.innerHTML = '';
        CHORD_DATA.forEach(chord => {
            const button = document.createElement('button');
            button.className = 'text-[10px] px-2 py-1.5 rounded bg-emerald-800 hover:bg-emerald-700 transition border border-emerald-600 text-white mb-1 mr-1 flex-grow text-center';
            button.textContent = chord.name;
            button.onclick = (e) => {
                e.stopPropagation(); 
                if (currentChordHighlight === chord) highlightChord(null);
                else highlightChord(chord, true);
            };
            listDiv.appendChild(button);
        });
    }

    function loadScores() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            savedScores = data ? JSON.parse(data) : [];
        } catch (e) { savedScores = []; }
        renderSavedScoresList();
    }

    function saveCurrentScore() {
        if (recordBuffer.length === 0) { showToast('ç„¡è¨˜éŒ„å¯å­˜'); return; }
        const scoreName = `ç·´ç¿’ ${new Date().toLocaleTimeString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}`;
        savedScores.push({ id: Date.now(), name: scoreName, buffer: JSON.parse(JSON.stringify(recordBuffer)) });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedScores));
        showToast(`å·²å„²å­˜`);
        renderSavedScoresList();
    }

    function loadSavedScore(id) {
        const score = savedScores.find(s => s.id === id);
        if (score) {
            recordBuffer = JSON.parse(JSON.stringify(score.buffer)); 
            recordStartTime = score.buffer[0] ? score.buffer[0].time : 0;
            lastRecordTime = score.buffer.length > 0 ? score.buffer[score.buffer.length - 1].time : 0;
            updateRecordDisplay();
            showToast(`å·²è¼‰å…¥`);
            toggleSavedRecords(false); 
        }
    }

    function deleteSavedScore(id) {
        savedScores = savedScores.filter(s => s.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedScores));
        renderSavedScoresList();
    }
    
    function renderSavedScoresList() {
        const listDiv = document.getElementById('savedRecordsList');
        listDiv.innerHTML = '';
        if (savedScores.length === 0) {
            listDiv.innerHTML = '<p class="text-xs text-gray-500 pt-2">ç„¡è¨˜éŒ„</p>';
            return;
        }
        savedScores.slice().reverse().forEach(score => {
            const el = document.createElement('div');
            el.className = 'flex justify-between items-center py-2 border-b border-gray-800 last:border-b-0';
            el.innerHTML = `
                <span class="text-sm text-white truncate w-32 cursor-pointer" onclick="loadSavedScore(${score.id})">${score.name}</span>
                <div class="flex gap-2">
                    <button class="text-xs text-green-400" onclick="loadSavedScore(${score.id})">è¼‰å…¥</button>
                    <button class="text-xs text-red-500" onclick="deleteSavedScore(${score.id})">åˆªé™¤</button>
                </div>
            `;
            listDiv.appendChild(el);
        });
    }

    function toggleSavedRecords(expand) {
        const sheet = document.getElementById('recordSidebar');
        const overlay = document.getElementById('overlayDim');
        const button = document.getElementById('openRecords');

        if (expand === undefined) expand = !isSheetExpanded;
        isSheetExpanded = expand;

        if (isSheetExpanded) {
            sheet.classList.add('is-expanded');
            sheet.style.transform = 'translateY(0)';
            overlay.classList.add('is-visible');
            button.classList.replace('bg-gray-500', 'bg-gray-400');
        } else {
            sheet.classList.remove('is-expanded');
            sheet.style.transform = 'translateY(calc(100% - 280px))'; 
            overlay.classList.remove('is-visible');
            button.classList.replace('bg-gray-400', 'bg-gray-500');
        }
    }

    function floatTo16BitPCM(output, offset, input) {
        for (let i = 0; i < input.length; i++, offset += 2) {
            let s = Math.max(-1, Math.min(1, input[i]));
            output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        }
    }
    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
    }
    function encodeWAV(samples, sampleRate) {
        const buffer = new ArrayBuffer(44 + samples.length * 2);
        const view = new DataView(buffer);
        writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + samples.length * 2, true); writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); 
        view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
        writeString(view, 36, 'data'); view.setUint32(40, samples.length * 2, true);
        floatTo16BitPCM(view, 44, samples);
        return view;
    }
    async function exportRecording() {
        if (recordBuffer.length === 0) { showToast('ç„¡éŒ„éŸ³'); return; }
        const loading = document.getElementById('loadingOverlay');
        loading.style.opacity = '1'; loading.style.pointerEvents = 'auto';
        try {
            const duration = (recordBuffer[recordBuffer.length-1].time / 1000) + 2;
            const offlineCtx = new OfflineAudioContext(1, duration * 44100, 44100);
            const comp = offlineCtx.createDynamicsCompressor();
            comp.threshold.value = -20; comp.ratio.value = 8;
            comp.connect(offlineCtx.destination);
            const gain = offlineCtx.createGain();
            gain.gain.value = 0.9; gain.connect(comp);
            recordBuffer.forEach(item => {
                playTone(scaleNotes[item.noteIndex].freq, 0.1 + item.time/1000, offlineCtx, gain);
            });
            const renderedBuffer = await offlineCtx.startRendering();
            const wav = encodeWAV(renderedBuffer.getChannelData(0), 44100);
            const blob = new Blob([wav], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Handpan_${Date.now()}.wav`;
            a.click();
        } catch (e) { showToast('åŒ¯å‡ºå¤±æ•—'); } 
        finally { loading.style.opacity = '0'; loading.style.pointerEvents = 'none'; }
    }

    function copyToClipboard() {
        if (recordBuffer.length === 0) return;
        let text = recordBuffer.map(i => i.label).join(' ');
        navigator.clipboard.writeText(text);
        showToast('å·²è¤‡è£½');
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.style.opacity = '1';
        setTimeout(() => t.style.opacity = '0', 1500);
    }

    document.getElementById('saveCurrent').addEventListener('click', saveCurrentScore);
    document.getElementById('openRecords').addEventListener('click', () => toggleSavedRecords());
    document.getElementById('dragHandle').addEventListener('click', () => toggleSavedRecords());
    document.getElementById('overlayDim').addEventListener('click', () => toggleSavedRecords(false));
    document.getElementById('playRecord').addEventListener('click', () => isPlaying ? stopPlayback() : playRecording());
    document.getElementById('copyRecord').addEventListener('click', copyToClipboard);
    document.getElementById('exportWav').addEventListener('click', exportRecording);
    document.getElementById('clearRecord').addEventListener('click', () => {
        if (isPlaying) stopPlayback();
        recordBuffer = []; recordStartTime = 0; lastRecordTime = 0;
        updateRecordDisplay();
    });
    document.getElementById('toggleLabels').addEventListener('click', (e) => {
        isLabelsVisible = !isLabelsVisible;
        e.target.textContent = isLabelsVisible ? 'éš±è—æ¨™ç±¤' : 'é¡¯ç¤ºæ¨™ç±¤';
        renderHandpan();
    });
    
    // New Listeners for Song/Practice
    document.getElementById('demoSong').addEventListener('click', loadSongForDemo);
    document.getElementById('practiceSong').addEventListener('click', startPracticeMode);

    const start = () => { initAudio(); document.getElementById('startOverlay').style.opacity='0'; setTimeout(()=>document.getElementById('startOverlay').remove(),500); };
    document.getElementById('startOverlay').addEventListener('click', start);
    document.getElementById('startOverlay').addEventListener('touchstart', (e)=>{e.preventDefault(); start();});

    window.onload = () => {
        loadScores(); renderHandpan(); renderChordList(); initSongSelect();
        window.addEventListener('resize', () => { adjustHandpanSize(); updateRecordDisplay(); });
        adjustHandpanSize(); 
        if (window.innerWidth < 768) toggleSavedRecords(false);
    };
</script>
</body>
</html>


